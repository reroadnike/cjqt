{template '_header'}
<style>
    .multi-item {margin-bottom: 18px;}
</style>
<div class="page-heading">
    <span class="pull-right">
        <a class="btn btn-default btn-sm" href="{php echo webUrl('goods/group')}"><i class="fa fa-reply"></i> 返回列表</a>
    </span>
    <h2>{if !empty($item)}编辑{else}新建{/if}商品组 <small>{if !empty($item)}(名称: {$item['name']}){/if}</small></h2>
</div>

<form {ife 'goods.group' $item}action="" method="post"{/if} class="form-validate form-horizontal ">

    <div class="form-group">
        <label class="col-sm-2 control-label">商品组名称</label>
        <div class="col-sm-9">
            {ife 'goods.group' $item}
                <input type="text" class="form-control valid" name="name" value="{$item['name']}" data-rule-required="true" placeholder="请输入商品组名称" />
            {else}
                <div class='form-control-static'>{$item['name']}</div>
            {/if}
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">商品组状态</label>
        <div class="col-sm-9 col-xs-12">
            {ife 'goods.group' $item}
                <label class="radio-inline">
                    <input type="radio" name="enabled" value="1" {if $item['enabled']==1}checked="checked"{/if}> 启用
                </label>
                <label class="radio-inline">
                    <input type="radio" name="enabled" value="0" {if $item['enabled']==0 || empty($item)}checked="checked"{/if}> 禁用
                </label>
            {else}
                <div class='form-control-static'>{if $item['enabled']==1}启用{else}禁用{/if}</div>
            {/if}
        </div>
    </div>

    <div class="form-group">
        <label class="col-sm-2 control-label">组内商品</label>
        <div class="col-sm-8">
            <div class="form-group" style="height: auto; display: block;">
                <div class="col-sm-12 col-xs-12">
                    {ife 'goods.group' $item}
                        <?php echo tpl_selector('goodsids',array('preview'=>true,'readonly'=>true, 'multi'=>1,'url'=>webUrl('goods/query'),'items'=>$goods,'buttontext'=>'选择商品','placeholder'=>'请选择商品,请输入商品ID(EQ)/京东SKU(EQ)/商品名称(LIKE)/商品关键字(LIKE)'))?>
                    {else}
                        <div class="input-group multi-img-details container ui-sortable">
                            {loop $goods $item}
                            <div data-name="goodsid" data-id="426" class="multi-item">
                                <img src="{php echo tomedia($item['thumb'])}" class="img-responsive img-thumbnail">
                                <div class="img-nickname">{$item['title']}</div>
                            </div>
                            {/loop}
                        </div>
                    {/if}
                </div>
            </div>
        </div>
        <div class="col-sm-2">
            <input type="file" name="excelfile" class="form-control" />
        </div>
    </div>


    <table class='table'>
        <tr>
            <td>
                {ife 'goods.group' $item}
                    <input type="submit" class="btn btn-primary" value="保存">
                {/if}
            </td>
        </tr>
        </tbody>
    </table>

</form>

{ife 'goods.group' $item}
    <script language="javascript">
        require(['jquery.ui'],function(){
            $('.multi-img-details').sortable();
        })

        /*
         * 这里是上传Excel
         * */
        $('input[name=excelfile]').on('change',function(){
            if(!$(":input[name=excelfile]").val()){
                tip.msgbox.err("您还未选择Excel文件哦~");
                return false;
            }

            $.ajax({
                url: "{php echo webUrl('goods/group/excelImport')}",
                type: 'POST',
                data: new FormData($('form')[0]),
                processData: false,
                contentType: false,
                dataType:"json",
                success: function (data) {
                    if(data.status == 1){
                        //<div class="multi-item" data-id="831" data-name="goodsids"><img class="img-responsive img-thumbnail" src="http://img13.360buyimg.com/n12/jfs/t2686/354/2853206386/80304/9712d32f/57761c7dN7724a31d.jpg"><div class="img-nickname">爱普生（EPSON）LQ-730KII 针式打印机 LQ-730K升级版 针式打印机（82列）</div><input type="hidden" value="831" name="goodsids[]"><em onclick="biz.selector.remove(this,'goodsids')" class="close">×</em></div>

                        var html = '';
                        var result = data.result
                        delete result.url
                        for(var i in result){
//                            console.log(result[i])
//                            console.log(result[i]['id'])
                            html += '<div class="multi-item" data-id="'+result[i]['id']+'" data-name="goodsids"><img class="img-responsive img-thumbnail" src="'+result[i]['thumb']+'"><div class="img-nickname">'+result[i]['title']+'</div><input type="hidden" value="'+result[i]['id']+'" name="goodsids[]"><em onclick="biz.selector.remove(this,"goodsids")" class="close">×</em></div>';
                        }

                        $('.multi-img-details').append(html);
                    }else{
                        tip.msgbox.err(data.result.message);
                    }
                }
            });
        });
    </script>
{/if}

{template '_footer'}