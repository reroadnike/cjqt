{template 'common/header'}


<style>
    .ul_option{list-style: none;
    }
    .ul_option li{
        padding: .3rem;
    }
</style>
<!--
<ul class="nav nav-tabs">
    <li class="active"><a href="{php echo $this->createWebUrl('boardroom_appointment', array('op' => 'list'))}">预约服务订单</a></li>
</ul>
-->

<div class="main">
    <div class="panel panel-info">
        <div class="panel-heading">筛选</div>
        <div class="panel-body">
            <!--<form action="{$url_search}" method="post" class="form-horizontal" role="form">-->
            <form action=""              method="post" class="form-horizontal form" enctype="multipart/form-data" id="form1">
                <input type="hidden" name="page" value=""/>
                <div class="form-group">
                    <label class="col-sm-1 col-md-1 col-lg-1 control-label">会议主题</label>
                    <div class="col-sm-2 col-lg-2">
                        <input class="form-control" name="subject" type="text" value="{$_GPC['subject']}">
                    </div>
                    <label class="col-sm-1 col-md-1 col-lg-1 control-label">姓名</label>
                    <div class="col-sm-2 col-lg-2">
                        <input class="form-control" name="client_name" type="text" value="{$_GPC['client_name']}">
                    </div>
                    <label class="col-sm-1 col-md-1 col-lg-1 control-label">电话</label>
                    <div class="col-sm-2 col-lg-2">
                        <input class="form-control" name="client_telphone" type="text" value="{$_GPC['client_telphone']}">
                    </div>


                    <div class="col-xs-3 col-sm-3 col-lg-3" style="text-align: right;">
                        <button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
                        <button class="btn btn-success" name="out_put" value="output"><i class="fa fa-file"></i> 导出</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-xs-1 col-sm-1 col-md-1 control-label">审核状态</label>
                    <div class="col-sm-2 col-xs-2">
                        <select class="form-control" name="status">
                            <option value="0">全部</option>
                            <option value="-1" {if $_where[status] == -1}selected="selected"{/if}>已取消</option>
                            <option value="1" {if $_where[status] == 1}selected="selected"{/if}>待审核</option>
                            <option value="3" {if $_where[status] == 3}selected="selected"{/if}>已审核</option>
                        </select>
                    </div>
                    <label class="col-xs-1 col-sm-1 col-md-1 control-label">属性</label>
                    <div class="col-sm-2 col-xs-2">
                        <select class="form-control" name="attribute">
                            <option value="0">请选择属性</option>
                            {loop $attributes $index $child_item}
                            <option value="{$child_item['id']}" {if $child_item['id'] == $attribute}selected="selected"{/if}>{$child_item['name']}</option>
                            {/loop}
                        </select>
                    </div>

                    <label class="col-xs-1 col-sm-1 col-md-1 control-label">分页大小</label>
                    <div class="col-sm-2 col-xs-2">
                        <select class="form-control" name="page_size">
                            <option value="5" {if $page_size == 5}selected="selected"{/if}>5</option>
                            <option value="10" {if $page_size == 10}selected="selected"{/if}>10</option>
                            <option value="20" {if $page_size == 20}selected="selected"{/if}>20</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">


                    <label class="col-xs-1 col-sm-1 col-md-1 control-label">楼宇/楼层</label>
                    <div class="col-sm-4 col-xs-4">
                        {php echo tpl_form_field_category_2level('structures', $parent, $children, $structures_parentid, $structures_childid)}
                    </div>

                </div>



            </form>
        </div>
    </div>

    <!--
    <div class="panel panel-info">
        <div class="panel-heading">导出</div>
        <div class="panel-body">
            <form action="{$url_export}" method="post" class="form-horizontal" role="form">
                <div class="form-group">
                    <label class="col-xs-1 col-sm-1 col-md-1 control-label">下单时间</label>
                    <div class="col-sm-2 col-xs-4">
                        {php echo tpl_form_field_daterange('date', array('start' => $_GPC['date']['start'] ,'end' => $_GPC['date']['end']), false)}
                    </div>
                    <div class=" col-xs-12 col-sm-2 col-lg-2">
                        <button class="btn btn-default"><i class="fa fa-search"></i> 导出</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    -->
</div>
<div class="main">
    <form action="" method="post">
        <div class="panel panel-default">

            <div class="panel-body table-responsive">
                <table class="table table-hover">
                    <thead class="navbar-inner">
                    <tr>
                        <!--<th style="width:5rem;">显示顺序</th>-->
                        <!--<th style="width:5%;">ID</th>-->
                        <!--<th style="width:8%;">项目码</th>-->
                        <!--<th style="width:6%;">企业码</th>-->
                        <th style="width:14.3%;">订单号</th>
                        <th style="width:14.3%;">姓名|电话</th>
                        <th style="width:14.3%;">会议室/会议主题(人数)</th>
                        <!--<th style="width:8%;">支付方式</th>-->
                        <!--<th style="width:10%;">openid</th>-->
                        <!--<th style="width:10%;">删除(1已删除)</th>-->
                        <!--<th style="width:10%;">审核状态(1同意)</th>-->
                        <!--<th style="width:10%;">关联会员表</th>-->
                        <!--<th style="width:10%;">会议用时</th>-->
                        <!--<th style="width:7%;">单价</th>-->
                        <!--<th style="width:7%;">总价</th>-->
                        <th style="width:14.3%;">使用时间</th>
                          <th style="width:14.3%;">状态<br/>(审核)</th>
                        <th style="width:14.3%;">下单时间</th>
                        <!--<th style="width:10%;">预约开始时间</th>-->
                        <!--<th style="width:10%;">预约结束时间</th>-->
                        <th style="text-align:right; width:14.3%;">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    {loop $list $item}
                    <tr>
                        <!--<td><input type="text" class="form-control" name="displayorder[{$item['id']}]" style="width: 5rem;" value="{$item['displayorder']}"></td>-->
                        <!--<td>{$item['id']}</td>-->
                        <!--<td>{$item['organization_code']}</td>-->
                        <!--<td>{$item['virtual_code']}</td>-->
                        <td data-boardroom_id="{$item['boardroom_id']}"><a title="{$item['organization_code']} - {$item['virtual_code']}">{$item['out_trade_no']}</a></td>
                        <td>{$item['client_name']}
                        <br/>{$item['client_telphone']}</td>
                        <td>
                            {$item['boardroom']['name']}
                            <br/>
                            {$item['subject']}({$item['people_num']})
                        </td>
                        <!--<td><span class="label label-{$item['css']}">{$item['paytype']}</span></td>-->
                        <!--<td>{$item['openid']}</td>-->
                        <!--<td>{$item['deleted']}</td>-->
                        <!--<td>{$item['state']}</td>-->
                        <!--<td>{$item['relate_id']}</td>-->
                        <!--<td>{$item['quantity']} 小时</td>-->
                        <!--<td>{$item['price']}</td>-->
                        <!--<td>{$item['total']}</td>-->
                        <td>{$item['lable_ymd']}<br/>{$item['lable_time']}</td>
                        <td>
                            <label
                                data="{$item['status']}"
                                id="status_{$item['id']}"
                                class="label {if $item['status'] == 3 }label-success{else}label-{$item['status_css']}{/if}"

                                {if $item['status'] == 1 || $item['status'] == 2} onclick="setProperty(this,{$item['id']},'status')" {else}  {/if}>
                                {if $item['status'] == 3 }已审核{else}{$item['status_name']}{/if}
                            </label>
                            <!-- 订单审核只能有不可逆的审核操作 $item['status'] == 3 || -->
                        </td>
                        <td>
                            {if isset($item['createtime'])}
                            {php echo date('Y-m-d',$item['createtime'])}<br/>{php echo date('H:i:s',$item['createtime'])}
                            {/if}
                        </td>
                        <!--<td>{$item['starttime']}</td>-->
                        <!--<td>{$item['endtime']}</td>-->
                        <td style="text-align:right;">
                            <ul class="ul_option">
                                <!--
                                <li>
                                    <a href="{php echo $this->createWebUrl('boardroom_appointment', array('id' => $item['id'], 'op' => 'edit'));}"
                                       class="btn btn-default btn-xs"
                                       data-toggle="tooltip"
                                       data-placement="top"
                                       title="编辑"><i class="fa fa-pencil">&nbsp;编辑</i></a>
                                </li>
                                -->
                                <li>
                                    <a href="{php echo $this->createWebUrl('boardroom_appointment_detail', array('out_trade_no' => $item['out_trade_no']));}"
                                       class="btn btn-default btn-xs"
                                       data-toggle="tooltip"
                                       data-placement="top"
                                       title="编辑"><i class="fa fa-pencil">&nbsp;详情</i></a>
                                </li>
                                {if $item['status'] != -1 }
                                {if $_GPC['__state'] == 'manage'}
                                <li>
                                    <a href="javascript:void(0);"
                                       class="btn btn-default btn-xs btn_cancel"
                                       data-toggle="tooltip"
                                       data-placement="top"
                                       data-id="{$item['id']}"
                                       title="取消"><i class="fa fa-pencil">&nbsp;取消</i></a>
                                </li>
                                {/if}
                                {else}
                                {/if}
                                {if $_GPC['__state'] == 'manage'}
                                <li>
                                    <a href="{php echo $this->createWebUrl('boardroom_appointment', array('id' => $item['id'], 'op' => 'delete'));}" class="btn btn-xs btn-danger" data-toggle="tooltip" data-placement="top" title="" onclick="if(!confirm('删除后将不可恢复,确定删除吗?')) return false;" data-original-title="删除"><i class="fa fa-times">&nbsp;删除</i> </a>
                                </li>
                                {/if}
                            </ul>
                        </td>
                    </tr>
                    {/loop}
                    {if empty($list)}
                    <tr>
                        <td colspan="8" style="text-align: center;">
                            未有预约服务订单
                        </td>
                    </tr>
                    {/if}
                    <tr>
                        <td>
                            <!--<input name="submit" type="submit" class="btn btn-primary" value="提交">-->
                            <input type="hidden" name="token" value="{$_W['token']}" />
                            {$total}
                        </td>
                        <td colspan="7">
                            {$pager}
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </form>
</div>

<!--<link rel="stylesheet" type="text/css" href="{MODULE_URL}static/js/dist/jquery-confirm/jquery-confirm.css"/>-->
<!--<script type="text/javascript" src="{MODULE_URL}static/js/dist/jquery-confirm/jquery-confirm.min.js"></script>-->

<script type="text/javascript">
    $(function () {
        $(".pagination > li > a[page!='']").each(function (index, element) {
            $(this).bind('click', function (event) {
                $("input[name='page']").val($(this).attr('page'));
                $("#form1").get(0).submit(function (e) {});
            });
        });
    });
</script>
<script type="text/javascript">
    function setProperty(obj, id, type) {

        if(obj.getAttribute("data") == 3){
            return;
        }
        if(!confirm('确认通过审核该订单？')){
            return;
        }
        $(obj).html($(obj).html() + "...");

//        console.log({id: id, type: type, data: obj.getAttribute("data")});

        $.post(
                "{php echo $this->createWebUrl('boardroom_appointment',array('op' => 'set_property'))}"
                , {id: id, type: type, data: obj.getAttribute("data")}
                , function (d) {
                    $(obj).html($(obj).html().replace("...", ""));
                    if (type == 'status') {
                        $(obj).html(d.data == '3' ? '已审核' : '待审核');
                    }
                    $(obj).attr("data", d.data);
                    if (d.result == 1) {
                        if(d.data == '3'){
                            $(obj).removeClass("label-info").addClass("label-success");
                        } else if(d.data == '1'){
                            $(obj).removeClass("label-success").addClass("label-info");
                        }

                    }
                }
                , "json"
        );
    }
    $(".btn_cancel").on("click",function(event){
        var that = $(this);
        var that_id = that.data("id");
        var target_lable = $("#status_"+that_id);

        $.post(
            "{php echo $this->createWebUrl('boardroom_appointment', array('op' => 'cancel'));}" + "&id=" + that_id,
            {},
            function (data, status) {
                console.log("Data: " + data + "\nStatus: " + status);
                data = JSON.parse(data);
//                $.alert({
//                    title: '提示',
//                    content: data.msg,
//                });
                if(data.data == 1){
//                    console.log("{php echo referer()}");
//                    window.location.href='';
                    target_lable.html("已取消");
                    target_lable
                            .removeClass("label-danger")
                            .removeClass("label-info")
                            .removeClass("label-warning")
                            .removeClass("label-success")
                            .addClass("label-default");
                    target_lable.attr("data", -1);
                    that.remove();

                }
            }
        );
    });

</script>
{template 'common/footer'}
