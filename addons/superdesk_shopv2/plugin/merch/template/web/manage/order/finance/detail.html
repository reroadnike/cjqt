{template '_header'}
<style type='text/css'>
    .ordertable { width:100%;position: relative;margin-bottom:10px}
    .ordertable tr td:first-child { text-align: right }
    .ordertable tr td {padding:10px 5px 0;vertical-align: top}
    .ordertable1 tr td { text-align: right; }
    .ops .btn { padding:5px 10px;}
</style>
<div class="page-heading"> <h2>订单详情</h2> </div>

<form class="form-horizontal form" action="" method="post">
    <input type="hidden" name="id" value="{$item['id']}" />


    <div  class='row order-container'>
        <div class="order-container-left">
            <div class='panel-body' >
                <h4 class="m-t-none m-b">订单信息</h4>
                <div class="form-group" style='padding:0 10px;'>
                    <table class='ordertable' style='table-layout:fixed'>
                        <tr>
                            <td style='width:80px'>订单编号：</td>
                            <td>{$item['ordersn']}</td>
                        </tr>
                        <tr>
                            <td>订单金额：</td>
                            <td>￥{php echo number_format($item['price'],2)}&nbsp;&nbsp;&nbsp;
                                <a data-toggle='popover' data-html='true' data-placement='right' data-content="
<table style='width:100%;'>
    <tr>
        <td  style='border:none;text-align:right;'>商品小计：</td>
        <td  style='border:none;text-align:right;'>￥{php echo number_format( $item['goodsprice'] ,2)}</td>
    </tr>
    <tr>
        <td  style='border:none;text-align:right;'>运费：</td>
        <td  style='border:none;text-align:right;'>￥{php echo number_format( $item['olddispatchprice'],2)}</td>
    </tr>
    {if $item['discountprice']>0}
    <tr>
        <td  style='border:none;text-align:right;'>会员折扣：</td>
        <td  style='border:none;text-align:right;'>-￥{php echo number_format( $item['discountprice'],2)}</td>
    </tr>
    {/if}
    {if $item['deductprice']>0}
    <tr>
        <td  style='border:none;text-align:right;'>积分抵扣：</td>
        <td  style='border:none;text-align:right;'>-￥{php echo number_format( $item['deductprice'],2)}</td>
    </tr>
    {/if}
    {if $item['deductcredit2']>0}
    <tr>
        <td  style='border:none;text-align:right;'>余额抵扣：</td>
        <td  style='border:none;text-align:right;'>-￥{php echo number_format( $item['deductcredit2'],2)}</td>
    </tr>
    {/if}
    {if $item['deductenough']>0}
    <tr>
        <td  style='border:none;text-align:right;'>商城满额立减：</td>
        <td  style='border:none;text-align:right;'>-￥{php echo number_format( $item['deductenough'],2)}</td>
    </tr>
    {/if}
    {if $item['merchdeductenough']>0}
    <tr>
        <td  style='border:none;text-align:right;'>商户满额立减：</td>
        <td  style='border:none;text-align:right;;'>-￥{php echo number_format( $item['merchdeductenough'],2)}</td>
    </tr>
    {/if}
    {if $item['couponprice']>0}
    <tr>
        <td  style='border:none;text-align:right;'>优惠券优惠：</td>
        <td  style='border:none;text-align:right;'>-￥{php echo number_format( $item['couponprice'],2)}</td>
    </tr>
    {/if}
    {if $item['isdiscountprice']>0}
    <tr>
        <td  style='border:none;text-align:right;'>促销优惠：</td>
        <td  style='border:none;text-align:right;;'>-￥{php echo number_format( $item['isdiscountprice'],2)}</td>
    </tr>
    {/if}
    {if intval($item['changeprice'])!=0}
    <tr>
        <td  style='border:none;text-align:right;'>卖家改价：</td>
        <td  style='border:none;text-align:right;'><span style='{if 0<$item['changeprice']}color:green{else}color:red{/if}'>{if 0<$item['changeprice']}+{else}-{/if}￥{php echo number_format(abs($item['changeprice']),2)}</span></td>
    </tr>
    {/if}
    {if intval($item['changedispatchprice'])!=0}
    <tr>
        <td  style='border:none;text-align:right;'>卖家改运费：</td>
        <td  style='border:none;text-align:right;'><span style='{if 0<$item['changedispatchprice']}color:green{else}color:red{/if}'>{if 0<$item['changedispatchprice']}+{else}-{/if}￥{php echo abs($item['changedispatchprice'])}</span></td>
    </tr>
    {/if}
    <tr>
        <td style='border:none;text-align:right;'>应收款：</td>
        <td  style='border:none;text-align:right;color:green;'>￥{php echo number_format($item['price'],2)}</td>
    </tr>
</table>
                                "><i class='fa fa-question-circle'></i></a></td>
                        </tr>

                        {if !empty($coupon)}
                        <tr>
                            <td>优惠券：</td>
                            <td><a href="{php echo merchUrl('sale/coupon/edit',array('id'=>$coupon['id']))}" target='_blank'>{$coupon['couponname']}</a>&nbsp;&nbsp;&nbsp;<a data-toggle='popover' data-html='true' data-placement='right'
                                                                                                                                                                      data-content="<table style='width:100%;'>

                <tr>
                    <td style='border:none;text-align:right;'>优惠方式：</td>
                    <td style='border:none;text-align:right;'>
                    {if $coupon['backtype']==0}
                        立减 {$coupon['deduct']} 元
                    {else if $coupon['backtype']==1}
                        打 {$coupon['discount']} 折
                    {else if $coupon['backtype']==2}
                        {if $coupon['backmoney']>0}返 {$coupon['backmoney']} 余额{/if}
                        {if $coupon['backcredit']>0}返 {$coupon['backcredit']} 积分{/if}
                        {if $coupon['backredpack']>0}返 {$coupon['backredpack']} 红包{/if}
                    {/if}
                    </td>
                </tr>


                {if $coupon['backtype']==2}
                    <tr>
                        <td style='border:none;text-align:right;'>返利方式：</td>
                        <td style='border:none;text-align:right;'>
                        {if $item['backwhen']==0}
                            交易完成后(过退款期限)
                        {else if $item['backwhen']==1}
                            订单完成后(收货后)
                        {else}
                            订单付款后
                        {/if}
                        </td>
                    </tr>

                    <tr>
                        <td style='border:none;text-align:right;'>返利情况：</td>
                        <td style='border:none;text-align:right;'>
                        {if empty($coupon['back'])}
                            未返利
                        {else}
                            已返利
                        {/if}
                        </td>
                    </tr>

                    {if !empty($coupon['back'])}
                    <tr>
                        <td style='border:none;text-align:right;'>返利时间：</td>
                        <td style='border:none;text-align:right;'>{php echo date('Y-m-d H:i',$coupon['backtime'])}</td>
                    </tr>
                    {/if}
                {/if}


            </table>
"><i class='fa fa-question-circle'></i></a></td>
                        </tr>
                        {/if}


                        <tr>
                            <td style='width:80px'>付款方式：</td>
                            <td>{if $item['paytype'] == 0}未支付{/if}
                                {if $item['paytype'] == 1}余额支付{/if}
                                {if $item['paytype'] == 11}后台付款{/if}
                                {if $item['paytype'] == 21}微信支付{/if}
                                {if $item['paytype'] == 22}支付宝支付{/if}
                                {if $item['paytype'] == 23}银联支付{/if}
                                {if $item['paytype'] == 3}企业月结{/if}</td>
                        </tr>

                        <tr>
                            <td>买家：</td>
                            <td><a href="{php echo merchUrl('member/list/detail',array('id'=>$member['id']))}" target='_blank'>{$member['nickname']}</a>
                                &nbsp;&nbsp;&nbsp;<a data-toggle='popover' data-html='true' data-placement='right' data-content="
<table style='width:100%;'>
    <tr>
        <td  style='border:none;text-align:right;' colspan='2'><img src='{$member['avatar']}' style='width:100px;height:100px;padding:1px;border:1px solid #ccc' /></td>
    </tr>
    <tr>
        <td  style='border:none;text-align:right;'>ID：</td>
        <td  style='border:none;text-align:right;'>{$member['id']}</td>
    </tr>
    <tr>
        <td  style='border:none;text-align:right;'>昵称：</td>
        <td  style='border:none;text-align:right;'>{$member['nickname']}</td>
    </tr>
    <tr>
        <td  style='border:none;text-align:right;'>姓名：</td>
        <td  style='border:none;text-align:right;'>{$member['realname']}</td>
    </tr>
    <tr>
        <td  style='border:none;text-align:right;'>手机号：</td>
        <td  style='border:none;text-align:right;'>{$member['mobile']}</td>
    </tr>
    <tr>
        <td  style='border:none;text-align:right;'>微信号：</td>
        <td  style='border:none;text-align:right;'>{$member['weixin']}</td>
    </tr>
</table>
                                "><i class='fa fa-question-circle'></i></a></td>
                        </tr>
                        {if !empty($item['invoice'])}
                        <tr>
                            <td style='width:80px'>发票信息：</td>
                            <td>
                                {$user_invoice['invoice']}<br/>
                                <a class='js-clip' data-url="{$user_invoice['invoice']}">[复制]</a>
                            </td>
                        </tr>
                        {/if}

                        <!-- 修改 发票信息-->
                        {if !empty($item['invoiceid'])}
                        {ifp 'order.op.changeinvoice'}
                        <tr>
                            <td style='width:80px'></td>
                            <td style='word-break: break-all;white-space: normal'>
                                <a class="btn btn-primary btn-xs"
                                   data-toggle="ajaxModal"
                                   href="{php echo merchUrl('order/op/changeinvoice', array('id' => $item['id']))}">编辑发票信息</a>
                            </td>
                        </tr>
                        {/if}
                        {/if}


                    </table>

                    <table class='ordertable' style='table-layout:fixed;border-top:1px dotted #ccc'>

                        <tr>
                            <td style='width:80px'>配送方式：</td>
                            <td>
                                {if $item['isverify'] == 1}
                                    线下核销
                                {elseif !empty($item['addressid'])}
                                    快递
                                {elseif !empty($item['isvirtualsend']) || !empty($item['virtual'])}
                                    自动发货{if !empty($item['isvirtualsend'])}(虚拟物品){else}(虚拟卡密){/if}
                                {elseif $item['dispatchtype']}
                                    自提
                                {else}
                                    其他
                                {/if}
                            </td>
                        </tr>

                        {if $item['isverify']==1}
                            <tr>
                                <td style='width:80px'>核销方式：</td>
                                <td>{if $item['verifytype']==0}

                                    整单核销
                                    {elseif $item['verifytype']==1}
                                    按次核销
                                    {elseif $item['verifytype']==2}
                                    按消费码核销
                                    {/if}

                                </td>
                            </tr>

                            {if $item['verifytype']==0}
                                <tr>
                                    <td style='width:80px'>消费码：</td>
                                    <td>{$item['verifycode']}</td>
                                </tr>
                                {if $item['verified']}
                                <tr>
                                    <td style='width:80px'>核销时间：</td>
                                    <td>{php echo date('Y-m-d H:i:s', $item['verifytime'])}</td>
                                </tr>
                                {if !empty($saler)}
                                <tr>
                                    <td style='width:80px'>核销人：</td>
                                    <td>{$saler['nickname']}( {$saler['salername']} )</td>
                                </tr>
                                {/if}
                                {if !empty($store)}
                                <tr>
                                    <td style='width:80px'>核销门店：</td>
                                    <td>{$store['storename']}</td>
                                </tr>
                                {/if}
                            {/if}

                        {elseif $item['verifytype']==1}
                        <tr>
                            <td style='width:80px'>消费记录：</td>
                            <td>
                                <a href='javascript:;' onclick='$("#verify-modal").modal()'><i class="fa fa-question-circle"></i> 查看</a>

                                <div id="verify-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">

                                    <div class="modal-dialog" style='width:850px'>
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                                                <h3>核销记录</h3>
                                            </div>
                                            <div class="modal-body" >
                                                <div style='max-height:500px;overflow:auto;min-width:800px;'>
                                                    <table style='width:100%;' class='table'>
                                                        <tr><td style='width:150px'>时间</td><td style='width:100px'>核销员</td><td>门店</td></tr>
                                                        {loop $verifyinfo $v}
                                                            <tr><td>{php echo date('Y-m-d H:i',$v['verifytime'])}</td><td>{$v['salername']}<br/><small>{$v['nickname']}</small></td><td>{$v['storename']}</td></tr>
                                                        {/loop}
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="modal-footer">

                                                <a href="#" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</a>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </td>
                        </tr>



                        {elseif $item['verifytype']==2}
                        <tr>
                            <td style='width:80px'>消费码：</td>
                            <td>{$item['verifycode']}</td>
                        </tr>
                        {loop $verifyinfo $v}
                        {if $v['verified']}
                        <tr>
                            <td style='width:80px'>{$v['verifycode']}</td>
                            <td>
                                <a data-toggle='popover' data-html='true' data-placement='right'
                                   data-content="
<table style='width:100%;'>

<tr>
    <td  style='border:none;text-align:right;'>核销员：</td>
    <td  style='border:none;text-align:right;'>{$v['salername']}/{$v['nickname']}</td>
</tr>
<tr>
    <td  style='border:none;text-align:right;'>门店：</td>
    <td  style='border:none;text-align:right;'>{$v['storename']}</td>
</tr>
<tr>
    <td  style='border:none;text-align:right;'>时间：</td>
    <td  style='border:none;text-align:right;'>{php echo date('Y-m-d H:i',$v['verifytime'])}</td>
</tr>

</table>
                                                " ><i class="fa fa-question-circle"></i> 使用信息</a>
                            </td>
                        </tr>
                        {/if}
                        {/loop}

                        {/if}

                        {/if}

                        {if !empty($item['addressid'])}
                        <tr>
                            <td style='width:80px'>收货人：</td>
                            <td style='word-break: break-all;white-space: normal'>
                                {$user_address['address']}, {$user_address['realname']}, {$user_address['mobile']}<br/>
                                <a class='js-clip' data-url="{$user_address['address']}, {$user_address['realname']}, {$user_address['mobile']}">[复制]</a>
                            </td>
                        </tr>
                        <!-- 修改 收货地址 -->
                        {if !empty($item['addressid'])}
                        {ifp 'order.op.changeaddress'}
                        <tr>
                            <td style='width:80px'></td>
                            <td style='word-break: break-all;white-space: normal'><a class="btn btn-primary btn-xs" data-toggle="ajaxModal" href="{php echo merchUrl('order/op/changeaddress', array('id' => $item['id']))}">编辑收货信息</a></td>
                        </tr>
                        {/if}
                        {/if}

                        {elseif $item['isverify']==1 || !empty($item['virtual']) ||!empty($item['isvirtual'])}
                            {if $item['status']>=2 && !empty($item['virtual']) }
                                <tr>
                                    <td style='width:80px'>发货信息：</td>
                                    <td style='word-break: break-all;white-space: normal'>{php echo str_replace("\n","<br/>", $item['virtual_str'])}</td>
                                </tr>
                            {/if}

                            <tr>
                                <td style='width:80px'>联系人：</td>
                                <td style='word-break: break-all;white-space: normal'>{$user_address['carrier_realname']}, {$user_address['carrier_mobile']}</td>
                            </tr>
                        {else}
                            <tr>
                                <td style='width:80px'>自提码：</td>
                                <td>{$item['verifycode']}</td>
                            </tr>
                            <tr>
                                <td style='width:80px'>自提人：</td>
                                <td style='word-break: break-all;white-space: normal'>{$user_address['address']},  {$user_address['realname']}, {$user_address['mobile']}</td>
                            </tr>
                        {/if}

                        {if !empty($item['remark'])}
                        <tr>
                            <td style='width:80px'>买家备注：</td>
                            <td>{$item['remark']}</td>
                        </tr>
                        {/if}




                    </table>

                    {if !empty($order_data)}
                    <table class='ordertable' style='table-layout:fixed;border-top:1px dotted #ccc'>
                        <tr>
                            <td style='width:120px'><h4>统一下单信息</h4></td>
                            <td></td>
                        </tr>
                        {php $datas = $order_data}
                        {php $ii = 0;}
                        {loop $order_fields $key $value}

                        <tr {if $ii>1}class="diymore2" style="display:none;"{/if}>
                            <td style='width:80px'>{php echo $value['tp_name']}：</td>
                            <td>
                                {template 'diyform/diyform'}

                            </td>
                        </tr>

                        {if $ii==2}
                        <tr class="diymore22">
                            <td colspan="2"><a href="javascript:void(0);" style="padding-right: 100px;" id="showdiymore2">查看完整信息</a></td>
                        </tr>
                        {/if}

                        {php $ii++;}
                        {/loop}
                    </table>
                    {/if}
                </div>
            </div>
        </div>

    </div>

    <br>



    <div class="panel panel-default">
        <div class="panel-heading">
            <span>商品信息</span>
        </div>
        <div class="panel-body table-responsive">
            <table class="table table-hover">
                <thead class="navbar-inner">
                <tr>
                    <th style="width:200px">标题</th>
                    <th>规格/编号/条码/京东SKU</th>
                    <th style="text-align: right;">单价(元)/数量</th>
                    <th style="text-align: right;">折扣前/折扣后(元)</th>
                    {if !empty($goods['diyformdata']) && $goods['diyformdata'] != 'false'}
                    <th style="width:80px;"></th>
                    {/if}
                    <th style="text-align: right;">退货数量</th>
                    <!--<th style="width:5%;">操作</th>-->
                </tr>
                </thead>
                {loop $item['goods'] $goods}
                <tr>
                    <td class='full'>
                        {if $category[$goods['pcate']]['name']}
                        <span class="text-error">[{$category[$goods['pcate']]['name']}] </span>{/if}{if $children[$goods['pcate']][$goods['ccate']][1]}
                        <span class="text-info">[{$children[$goods['pcate']][$goods['ccate']][1]}] </span>
                        {/if}
                        {$goods['title']} {if !empty($goods['invoice'])}<label class='label label-danger'>支持开票</label>{/if}
                    </td>
                    <td>

                        <span style="white-space:normal;">规格 : {if !empty($goods['optionname'])}<span class="label-info" style="font-family: 微软雅黑;font-size: 12px;font-weight: 600;">{$goods['optionname']}</span>{else}--/--{/if}</span>
                        <br/>编码 : {if !empty($goods['goodssn'])}{$goods['goodssn']}{else}--/--{/if}
                        <br/>条码 : {if !empty($goods['productsn'])}{$goods['productsn']}{else}--/--{/if}
                        <br/>京码 : {if !empty($goods['jd_vop_sku'])}{$goods['jd_vop_sku']}{else}--/--{/if}
                    </td>
                    <td style="text-align: right;">
                        {$goods['marketprice']}
                        <br/>
                        x {$goods['total']}
                    </td>
                    <td style='color:red;font-weight:bold;text-align: right;'>
                        {$goods['orderprice']} / {$goods['realprice']}
                        {if intval($goods['changeprice'])!=0}
                        <br/>(改价{if $goods['changeprice']>0}+{/if}{php echo number_format(abs($goods['changeprice']),2)})
                        {/if}
                    </td>

                    {if !empty($goods['diyformdata']) && $goods['diyformdata'] != 'false'}
                    <td>
                        <a href='javascript:;' class=btn-xs' hide="1"  data="{$goods['id']}" onclick="showDiyInfo(this)">自定义信息</a>
                    </td>
                    {/if}


                    <td style='color:red;font-weight:bold;text-align: right;'>
                        <br/>
                        x {$goods['return_goods_nun']}
                    </td>

                    <!--td>
                        <a href="{php echo merchUrl('goods/edit', array('id' => $goods['id']))}" class="btn btn-default btn-sm" title="编辑"><i class="fa fa-edit"></i></a>&nbsp;&nbsp;
                    </td-->
                </tr>

                {if !empty($goods['diyformdata']) && $goods['diyformdata'] != 'false'}
                <tr>
                    <td colspan='5'>
                        <table class='ordertable' style='table-layout:fixed;display: none;' id="diyinfo_{$goods['id']}">
                            {php $datas = $goods['diyformdata']}
                            {loop $goods['diyformfields'] $key $value}
                            <tr>
                                <td style='width:80px'>{php echo $value['tp_name']}：</td>
                                <td>
                                    {template 'diyform/diyform'}
                                </td>
                            </tr>
                            {/loop}
                        </table>
                    </td>
                </tr>
                {/if}
                {/loop}

            </table>
        </div>
    </div>
</form>

<script language='javascript'>
    $(function () {
        $("#showdiymore1").click(function () {
            $(".diymore1").show();
            $(".diymore11").hide();
        });

        $("#showdiymore2").click(function () {
            $(".diymore2").show();
            $(".diymore22").hide();
        });
    });

    function showDiyInfo(obj){
        var data = $(obj).attr('data');
        var id = "diyinfo_" + data;

        var hide = $(obj).attr('hide');
        if(hide=='1'){
            $("#"+id).slideDown();
        }
        else{
            $("#"+id).slideUp();
        }
        $(obj).attr('hide',hide=='1'?'0':'1');
    }

</script>

{template '_footer'}
