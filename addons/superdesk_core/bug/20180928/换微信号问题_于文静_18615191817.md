#已记录PM 
#已解决

20180928_杨宇迪_换微信号问题_于文静_18615191817.md



商城帐号


------------------------------------------------------------------------

1677

oX8KYwq-ok4aeEb9f0846jDtCNlU

山东建行
山东建行物业项目部

积分
0.00
余额
0.00

18615191817 已绑定

------------------------------------------------------------------------





------------------------------------------------------------------------

4992

oX8KYwhxSSBSy1v8RSlQKMGAgU6g

项目名称 为空
企业名称 为空

积分
0.00
余额
0.00

手机为空 未绑定

------------------------------------------------------------------------



$userMobile = 18615191817
$_W['openid'] = 'oX8KYwhxSSBSy1v8RSlQKMGAgU6g'


$isBind = $this->_memberService->isBindMember($userMobile, $_W['openid']);

$isBind == false 


```php
            // 以下为合并帐号处理 start

            // debug // 在浏览器登陆会出显 $_shop_member_openid 为 false 原因是 $_W['openid'] 为 '' 此情况在 企业采购-正式 中测出
            $_shop_member_openid = $this->_memberService->getOneByOpenid($_W['openid']); // query shop member by openid
            $_shop_member_mobile = $this->_memberService->getOneByMobile($userMobile); // query shop member by mobile


            if ($_shop_member_mobile) {

                //
                if ($_shop_member_mobile['openid'] == $_W['openid']) {// 正常用户

                    // 将tb_user 的信息更新到 shop_member ，　因为那些人有可以更改公司

                    $this->_memberService->syncTbUser($_shop_member_mobile['id'], $_tb_user);

                } else if ($_shop_member_mobile['openid'] != $_W['openid']) {// 换了微信号的帐号

                    socket_log('浏览器中会误报:换了微信号的帐号情况:openid: |' . $_W['openid'] . '|');

                    if(!empty($_W['openid']) && $_shop_member_openid){ // 保证是在微信中去做这个事

                        socket_log('换了微信号的帐号-情况');

                        // debug // 在浏览器登陆会出显 $_shop_member_openid 为 false 原因是 $_W['openid'] 为 '' 此情况在 企业采购-正式 中测出
                        socket_log("account:checkEnterpriseUserLogin:openid: | " . $_W['openid'] . ' | ' . json_encode($_shop_member_openid, JSON_UNESCAPED_UNICODE));
                        socket_log("account:checkEnterpriseUserLogin:mobile: | " . json_encode($_shop_member_mobile, JSON_UNESCAPED_UNICODE));

                        if ($this->_memberService->iswxm($_shop_member_mobile)) { // 判定 这个帐号的来源是微信吗? 如果是微信才合并
                            $this->_memberService->merge($_shop_member_mobile, $_shop_member_openid);
                        }
                    }

                } else { // 异常:同样电话的信息

                    // bind => 合并帐号
                    // 将tb_user 的信息更新到 shop_member

                    // SELECT * FROM `ims_superdesk_shop_member` WHERE openid LIKE 'wap_user_%' 还有1005未合并帐号
//                    socket_log("account:checkEnterpriseUserLogin:openid:" . json_encode($_shop_member_openid, JSON_UNESCAPED_UNICODE));
//                    socket_log("account:checkEnterpriseUserLogin:mobile:" . json_encode($_shop_member_mobile, JSON_UNESCAPED_UNICODE));

                    if (!$this->_memberService->iswxm($_shop_member_mobile)) { // 判定 这个帐号的来源是渠道吗? 如果是渠道才合并
                        $this->_memberService->merge($_shop_member_mobile, $_shop_member_openid);
                    }

                }

            } else if ($_shop_member_openid) { // 在浏览器登陆会出显 $_shop_member_openid 为 false
                // 将tb_user 的信息更新到 shop_member
                // realname
                // mobile
                // salt
                // pwd
                // comeform mobile
                // core_enterprise

//                if($_shop_member_openid['id'] == $_shop_member_mobile['id']){ // 此情况就是电话没到位的问题

                $this->_memberService->syncTbUser($_shop_member_openid['id'], $_tb_user);

//                } else {
//                    // bind => 合并帐号
//                    // 将tb_user 的信息更新到 shop_member
//                }
            }

            // 以下为合并帐号处理 end
```