<?php
/**
 * Created by linjinyu.
 * User: linjinyu
 * Date: 2018/03/30
 * Time: 15:24
 * http://192.168.1.124/smart_office_building/web/index.php?c=site&a=entry&m=superdesk_jd_vop&do=balance_detail
 */

global $_GPC, $_W;

include_once(IA_ROOT . '/addons/superdesk_jd_vop/service/JincaiService.class.php');
$_jincaiService = new JincaiService();

$op = !empty($_GPC['op']) ? $_GPC['op'] : 'billList';

$billId  = $_GPC['billId'] ? $_GPC['billId'] : '';
$orderId = $_GPC['orderId'] ? $_GPC['orderId'] : '';
$page      = $_GPC['page'];
$page_size = 100;

$repayStatus = array(
    '5001' => '正常',
    '5002' => '延期',
    '5003' => '逾期',
    '5004' => '已结清',
    '5005' => '延期已结清',
    '5006' => '逾期已结清',
);
$billType = array(
    '5106' => '月结',
    '5170' => '周结',
    '5102' => '文档没写'
);
$orderStatus = array(
    '2500' => '未结清',
    '2501' => '已结清',
);
$shopOrderStatus = array(
    -1 => '已关闭',
    0  => '待付款',
    1  => '待发货',
    2  => '待收货',
    3  => '已完成'
);

if ($op == 'billList') {
    //1 账单号 billId 为空，订单号 orderId 为空：baseData、billInfo 详见 获取金彩账单明细.type1.json

    $result = $_jincaiService->getBillDetail($billId, $orderId, $page, $page_size);

    $baseData = $result['result']['baseData'];
    $billInfo = $result['result']['billInfo'];

    $pager = pagination($billInfo['totalRecord'], $page, $page_size);

    $billInfoData = $billInfo['results'];

    include_once(IA_ROOT . '/addons/superdesk_jd_vop/model/bill.class.php');
    $_billModel = new billModel();

    foreach($billInfoData as $k => &$v){

        //数据库更新或保存
        $insert_data = $v;
        $insert_data['sumNrPri'] = $insert_data['nrRepayPri'];
        $insert_data['uniacid'] = $_W['uniacid'];
        unset($insert_data['repayStatus']);
        unset($insert_data['nrRepayPri']);
        $_billModel->saveOrUpdateByColumn($insert_data,$insert_data);


        $v['billStartDate'] = date('Y-m-d',$v['billStartDate'] / 1000);
        $v['billEndDate']   = date('Y-m-d',$v['billEndDate'] / 1000);
        $v['repayDate']     = date('Y-m-d',$v['repayDate'] / 1000);
        $v['repayStatus']   = $repayStatus[$v['repayStatus']];
    }
    unset($v);

    include $this->template('jincai_bill_list');

}elseif($op == 'billDetail'){
    //2 账单号 billId 不为空：baseData、billDetail、orderStatusDetail 详见 获取金彩账单明细.type2.json

    //代码步骤:
    //1 处理账单详情
    //1.1 查数据库是否保存
    //1.1.1 有保存并且已结清 输出
    //1.1.2 有保存但没结清 拉取京东数据 更新数据库 输出
    //1.1.3 没保存 创建数据库 输出
    //1.2 格式化账单数据中的时间.状态.类型
    //2 处理订单列表
    //2.1 查是否以获取京东数据的方式获取数据
    //2.1.1 是 跳过
    //2.1.2 否 获取京东数据
    //2.2 遍历京东订单列表 逐个查找数据库订单是否存在
    //2.2.1 有保存 已结清 直接获取数据库中的数据
    //2.2.2 没保存或者没结清 更新或保存 输出


    //先查账单表
    include_once(IA_ROOT . '/addons/superdesk_jd_vop/model/bill.class.php');
    $_billModel = new billModel();

    $databaseBill = $_billModel->getOneByColumn(array('uniacid'=>$_W['uniacid'],'billNo'=>$billId));

    //是否已经有在数据库保存
    if(!empty($databaseBill)){
        //有.则先判断一下是否已经结清
        if($databaseBill['status'] > 5003){
            //已结清
            $billDetail = $databaseBill;
        }else{
            //没结清,重新拉取并覆盖拉取的这部分数据
            $result = $_jincaiService->getBillDetail($billId, $orderId, $page, $page_size);

            $billDetail = $result['result']['billDetail'];
            $_billModel->updateByColumn($billDetail,array('uniacid'=>$_W['uniacid'],'billNo'=>$billId));
        }
    }else{
        //没找到.新增
        $result = $_jincaiService->getBillDetail($billId, $orderId, $page, $page_size);

        $billDetail = $result['result']['billDetail'];
        $_billModel->insert($billDetail);
    }

//    show_json(1,$billDetail);

    $billDetail['repayDate'] = date('Y-m-d',$billDetail['repayDate'] / 1000);
    $billDetail['delinDate'] = date('Y-m-d',$billDetail['delinDate'] / 1000);
    $billDetail['status']    = $repayStatus[$billDetail['status']];
    $billDetail['billType']  = $billType[$billDetail['billType']];

    $total = 0;
    $orderList = array();

    //上面是否已经请求过订单列表
    if(!isset($result)){
        $result = $_jincaiService->getBillDetail($billId, $orderId, $page, $page_size);
    }

    //抽出京东订单列表,订单总数
    $orderStatusDetail = $result['result']['orderStatusDetail'];
    $total = $orderStatusDetail['totalRecord'];
    $orderStatusDetailData = $orderStatusDetail['results'];

    include_once(IA_ROOT . '/addons/superdesk_jd_vop/model/bill_order.class.php');
    $_bill_orderModel = new bill_orderModel();

    foreach($orderStatusDetailData as $k => $v){
        //逐个查找数据库订单是否存在
        $databaseBillOrder = $_bill_orderModel->getOneByColumn(array('uniacid'=>$_W['uniacid'],'orderNo'=>$v['orderNo']));

        if(!empty($databaseBillOrder) && $databaseBillOrder['settleStatus'] == 2501){
            //有保存 已结清 直接获取数据库中的数据
            $orderDetail = $databaseBillOrder;
        }else{
            //没保存或者没结清 更新或保存 输出
            $orderDetail = getOrderDetail($_jincaiService,$_bill_orderModel,$v['orderNo'],$databaseBillOrder);
        }

        //格式处理
        $orderDetail['settleDate']   = $orderDetail['settleDate'] ? date('Y-m-d',$orderDetail['settleDate'] / 1000) : 0;
        $orderDetail['settleStatus'] = $orderStatus[$orderDetail['settleStatus']];
        $orderDetail['shopOrderStatus'] = $shopOrderStatus[$orderDetail['shopOrderStatus']];

        $orderList[] = $orderDetail;
    }

    $pager = pagination($total, $page, $page_size);

    include $this->template('jincai_bill_detail');

}elseif($op == 'constant'){ //同步账单下所有订单数据 即请求京东接口.然后更新数据库

    $total = 0;
    $orderList = array();
    $constPage = 1;
    $constPageSize = 1000;

    //请求订单列表
    $result = $_jincaiService->getBillDetail($billId, $orderId, $constPage, $constPageSize);

    //抽出京东订单列表,订单总数
    $orderStatusDetail = $result['result']['orderStatusDetail'];
    $total = $orderStatusDetail['totalRecord'];
    $orderStatusDetailData = $orderStatusDetail['results'];

    include_once(IA_ROOT . '/addons/superdesk_jd_vop/model/bill_order.class.php');
    $_bill_orderModel = new bill_orderModel();

    foreach($orderStatusDetailData as $k => $v){
        //逐个查找数据库订单是否存在
        $databaseBillOrder = $_bill_orderModel->getOneByColumn(array('uniacid'=>$_W['uniacid'],'orderNo'=>$v['orderNo']));

        if(!empty($databaseBillOrder) && $databaseBillOrder['settleStatus'] == 2501){
            //有保存 已结清 直接获取数据库中的数据
            $orderDetail = $databaseBillOrder;
        }else{
            //没保存或者没结清 更新或保存 输出
            $orderDetail = getOrderDetail($_jincaiService,$_bill_orderModel,$v['orderNo'],$databaseBillOrder);
        }

        //格式处理
        $orderDetail['settleDate']   = $orderDetail['settleDate'] ? date('Y-m-d',$orderDetail['settleDate'] / 1000) : 0;
        $orderDetail['settleStatus'] = $orderStatus[$orderDetail['settleStatus']];
        $orderDetail['shopOrderStatus'] = $shopOrderStatus[$orderDetail['shopOrderStatus']];

        $orderList[] = $orderDetail;
    }
}

function getOrderDetail($_jincaiService,$_bill_orderModel,$orderId,$databaseBillOrder){
    //3 订单号 orderId 不为空：baseData、orderDetail 详见 获取金彩账单明细.type3.json

    global $_W;

    //请求京东接口 获取订单详情
    $result = $_jincaiService->getBillDetail('', $orderId);

    $orderDetail = $result['result']['orderDetail'];

    //假如数据库中没记录
    if(empty($databaseBillOrder)){
        //获取商城对应订单的编号,状态,价格 保存
        $shopOrder = $_bill_orderModel->getOrderByJdOrderId($orderDetail['orderNo']);

        $orderDetail['shopOrderSn'] = $shopOrder['ordersn'];
        $orderDetail['shopOrderStatus'] = $shopOrder['status'];
        $orderDetail['shopOrderPrice'] = $shopOrder['costprice'];

        $_bill_orderModel->insert($orderDetail);
    }else{
        //判断是否有变更.有则更新
        if(
            $orderDetail['orderAmount'] != $databaseBillOrder['orderAmount'] ||
            $orderDetail['settleDate'] != $databaseBillOrder['settleDate'] ||
            $orderDetail['settleStatus'] != $databaseBillOrder['settleStatus'] ||
            $orderDetail['sumRefundAmount'] != $databaseBillOrder['sumRefundAmount'] ||
            $orderDetail['customerName'] != $databaseBillOrder['customerName']
        ){
            $_bill_orderModel->updateByColumn($orderDetail,array('uniacid'=>$_W['uniacid'],'orderNo'=>$orderId));
        }

        $orderDetail['shopOrderSn'] = $databaseBillOrder['shopOrderSn'];
        $orderDetail['shopOrderStatus'] = $databaseBillOrder['shopOrderStatus'];
        $orderDetail['shopOrderPrice'] = $databaseBillOrder['shopOrderPrice'];
    }

    return $orderDetail;
}